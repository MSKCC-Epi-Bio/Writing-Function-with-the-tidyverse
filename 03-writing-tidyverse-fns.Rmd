---
output: html_document
editor_options: 
  chunk_output_type: console
---
class: inverse, center, middle
# Writing tidyverse-style Functions

---

# Two Options for Writing tidyverse-style Functions

* Option 1: Write a function that uses **quoted** arguments in the function call

```{r, eval = FALSE}
# calling tbl_summary using quoted arguments
tbl_summary(trial, include = c("trt", "age"))
```

* Option 2: Write a function that uses **unquoted** arguments in the function call 
(also known as *bare arguments*)

```{r, eval = FALSE}
# calling tbl_summary using unquoted arguments (not all functions accept quoted + unquoted input)
tbl_summary(trial, include = c(trt, age))
```

* Requiring quoted or unquoted function arguments is a matter of developer 
preference

* May be slightly easier for the user to supply unquoted arguments (less typing)

* The type of argument required by the function (quoted or unquoted)
should be specified in the help file when writing functions more formally

---

class: inverse, center, middle
# Option 1: Functions that use quoted arguments in a function call

---

# Passing Strings to `dplyr` verbs

`dplyr` verbs: 

* `select()`: picks variables based on their names

* `filter()`: picks cases based on their values

* `arrange()`: changes the ordering of the rows

* `mutate()`: adds new variables based on existing variables

*From [dplyr website](https://dplyr.tidyverse.org/)

---

# Passing Strings to `dplyr` verbs

* This means that you want to use any of the `dplyr` verbs in your function, and want to pass a string.

For example:

```{r, eval = FALSE}
# using a function to select a single variable
my_function <- function(select_variable){
  mtcars %>% 
    dplyr::select(select_variable)
}

my_function(select_variable = "mpg")
my_function(select_variable = "wt")

# Note: Using an external vector in selections is ambiguous.
# i Use `all_of(select_variable)` instead of `select_variable` to silence this message.
# i See <https://tidyselect.r-lib.org/reference/faq-external-vector.html>.
```

Why did we get this note?

---

# Functions for Passing Strings to `dplyr` verbs

* `any_of()` and `all_of()` are helper functions to select variables from 
a character vector

* `any_of()`: selecting any of the listed variables

* `all_of()`: for strict selection. If any of the variables in the character vector is missing, an error is thrown

* Can also use `!all_of()` to select all variables not found in the character vector supplied to `all_of()`

```{r, eval = FALSE}
# using a function to select a single variable
my_function_improved <- function(select_variable){
  mtcars %>% 
    dplyr::select(dplyr::all_of(select_variable))
}

my_function_improved(select_variable = "mpg")
# no note!
```

---

# Functions for Passing Strings to `dplyr` verbs

* `across()`: if you want the user to provide a set of data-variables that are then transformed
•
* See `vignette("colwise")`

```{r, eval = FALSE}
summarise_mean <- function(data, vars) {
  data %>% 
    summarise(n = n(), across({{ vars }}, mean))
}

mtcars %>% 
  group_by(cyl) %>% 
  summarise_mean(where(is.numeric))
```

```{r}
my_summarise <- function(data, group_var, summarise_var) {
  data %>%
    group_by(across({{ group_var }})) %>% 
    summarise(across({{ summarise_var }}, mean))
}
```

* Use the `.names` argument to `across()` to control the names of the output.

```{r, eval=FALSE}
my_summarise <- function(data, group_var, summarise_var) {
  data %>%
    group_by(across({{ group_var }})) %>% 
    summarise(across({{ summarise_var }}, mean, .names = "mean_{.col}"))
}
```


---

# `.data[[ · ]]`

* `.data` $\ne$ data frame

* In `{tidyverse}` speak, `.data` is a *pronoun*

* Used as `.data$x` or `.data[[var]]`

---

# Naming variables within your function

* Cue, the walrus operator `:=`

---

class: inverse, center, middle

# Questions?